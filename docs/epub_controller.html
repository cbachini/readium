<!DOCTYPE html>  <html> <head>   <title>epub_controller.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="plugins.html">                 plugins.js               </a>                                           <a class="source" href="web_plugins.html">                 web_plugins.js               </a>                                           <a class="source" href="alternate_style_tag_selector.html">                 alternate_style_tag_selector.js               </a>                                           <a class="source" href="audioClipPlayer.html">                 audioClipPlayer.js               </a>                                           <a class="source" href="epub.html">                 epub.js               </a>                                           <a class="source" href="epub_controller.html">                 epub_controller.js               </a>                                           <a class="source" href="ibooks_options_parser.html">                 ibooks_options_parser.js               </a>                                           <a class="source" href="manifest_item.html">                 manifest_item.js               </a>                                           <a class="source" href="mediaOverlay.html">                 mediaOverlay.js               </a>                                           <a class="source" href="media_overlay_controller.html">                 media_overlay_controller.js               </a>                                           <a class="source" href="media_overlay_view_helper.html">                 media_overlay_view_helper.js               </a>                                           <a class="source" href="options_presenter.html">                 options_presenter.js               </a>                                           <a class="source" href="packageDocument.html">                 packageDocument.js               </a>                                           <a class="source" href="package_document_parser.html">                 package_document_parser.js               </a>                                           <a class="source" href="page_number_display_logic.html">                 page_number_display_logic.js               </a>                                           <a class="source" href="pagination_strategy_selector.html">                 pagination_strategy_selector.js               </a>                                           <a class="source" href="path_resolver.html">                 path_resolver.js               </a>                                           <a class="source" href="readium_options.html">                 readium_options.js               </a>                                           <a class="source" href="readium_pagination.html">                 readium_pagination.js               </a>                                           <a class="source" href="smilModel.html">                 smilModel.js               </a>                                           <a class="source" href="toc.html">                 toc.js               </a>                                           <a class="source" href="trigger.html">                 trigger.js               </a>                                           <a class="source" href="validated_package_meta_data.html">                 validated_package_meta_data.js               </a>                                           <a class="source" href="crx_library_namespace.html">                 crx_library_namespace.js               </a>                                           <a class="source" href="crx_viewer_namespace.html">                 crx_viewer_namespace.js               </a>                                           <a class="source" href="ws_lib_namespace.html">                 ws_lib_namespace.js               </a>                                           <a class="source" href="crx_library_router.html">                 crx_library_router.js               </a>                                           <a class="source" href="crx_viewer_router.html">                 crx_viewer_router.js               </a>                                           <a class="source" href="ws_router.html">                 ws_router.js               </a>                                           <a class="source" href="accessibility.html">                 accessibility.js               </a>                                           <a class="source" href="bb_file_system_sync.html">                 bb_file_system_sync.js               </a>                                           <a class="source" href="cookie_utils.html">                 cookie_utils.js               </a>                                           <a class="source" href="google_analytics_loader.html">                 google_analytics_loader.js               </a>                                           <a class="source" href="handlebars_helpers.html">                 handlebars_helpers.js               </a>                                           <a class="source" href="local_storage_sync.html">                 local_storage_sync.js               </a>                                           <a class="source" href="md5.html">                 md5.js               </a>                                           <a class="source" href="user_agent_utils.html">                 user_agent_utils.js               </a>                                           <a class="source" href="fixed_layout_book_zoomer.html">                 fixed_layout_book_zoomer.js               </a>                                           <a class="source" href="nav_widget_view.html">                 nav_widget_view.js               </a>                                           <a class="source" href="options_view.html">                 options_view.js               </a>                                           <a class="source" href="toc_view.html">                 toc_view.js               </a>                                           <a class="source" href="toolbar_view.html">                 toolbar_view.js               </a>                                           <a class="source" href="httpFileApi.html">                 httpFileApi.js               </a>                                           <a class="source" href="library.html">                 library.js               </a>                                           <a class="source" href="viewer.html">                 viewer.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               epub_controller.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Description: This model is a sort of "controller" for an ePUB, managing the interaction between calling code
  and the saved epub. This model also exposes and persists properties that determine how an epub is displayed in 
  Readium. Some of these properties are determined by the user, such as whether two pages are being displayed, the font size etc.
  Other properties are determined by the user's interaction with the reader and the structure of the book. These include
  the current spine item rendered in the viewer, as well the logic that governs changing the current spine item.  </p>

<p>Rationale: This model is designed to expose a useful concept of an "epub" to the rest of Readium. This includes the contents
  of the epub itself, as well as view properties (mentioned above) and the logic governing interaction with epub properties and 
  contents. It is the intention for this model that it have little to no knowledge of how an epub is rendered. It is intended 
  that Backbone attributes (getting/setting) and the backbone attribute event model (events fired on attribute changes) should 
  the primary ways of interacting with this model.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: Need to think about the purpose and implementation of the hash_fragment attribute</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">EPUBController</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>------------------------------------------------------------------------------------ //
 "PUBLIC" METHODS (THE API)                                                          //
------------------------------------------------------------------------------------ //</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>capture context for use in callback functions</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">epub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epub&quot;</span><span class="p">);</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;media_overlay_controller&quot;</span><span class="p">,</span> 
            <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">MediaOverlayController</span><span class="p">({</span><span class="nx">epubController</span> <span class="o">:</span> <span class="k">this</span><span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>create a <a href="/docs/paginator.html"><code>Paginator</code></a> object used to initialize
pagination strategies for the spine items of this book</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">paginator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">PaginationStrategySelector</span><span class="p">({</span><span class="nx">book</span><span class="o">:</span> <span class="k">this</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Get the epub package document</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">getPackageDocument</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>TODO: this might have to change: Should this model load the package document or epub_state??
load the <code>packageDocument</code> from the HTML5 filesystem asynchroniously</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>success callback is executed once the filesSystem contents have 
been read and parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>restore the position the reader left off at from cookie storage</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">restorePosition</span><span class="p">();</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>tell the paginator to start rendering spine items from the 
freshly restored position</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">items</span><span class="p">);</span>
				</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>check if a TOC is specified in the <code>packageDocument</code></p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">that</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;has_toc&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="o">!!</span><span class="nx">that</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span>
        </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>change:spine_position</code> is triggered whenver the reader turns pages
accross a <code>spine_item</code> boundary. We need to cache thier new position
and </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">savePosition</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If we encounter a new fixed layout section, we need to parse the 
<code>&lt;meta name="viewport"&gt;</code> to determine the size of the iframe</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:spine_position&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Description: Persists the attributes of this model
Arguments (
  attrs: doesn't appear to be used
  options: 
)
Rationale: Each epub unpacked and saved to the filesystem in Readium has a unique
  key. "_epubViewProperties" is appended to this unique key to persist the read/write
  attributes separately from the read-only attributes of the epub.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>TODO: this should be done properly with a backbone sync</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">ops</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ops</span><span class="p">,</span><span class="nx">options</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Set attributes required to persist the epub-specific viewer properties</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_epubViewProperties&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Persist viewer properties</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">Lawnchair</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">ops</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
		<span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
		<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
    	<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;full_screen&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;toolbar_visible&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    	<span class="s2">&quot;toc_visible&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    	<span class="s2">&quot;rendered_spine_items&quot;</span><span class="o">:</span> <span class="p">[],</span>
    	<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="s2">&quot;default-theme&quot;</span><span class="p">,</span>
    	<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    	<span class="s2">&quot;epubCFIs&quot;</span> <span class="o">:</span> <span class="p">{}</span>
  	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Description: serialize this models state to <code>JSON</code> so that it can
  be persisted and restored</p>             </td>             <td class="code">               <div class="highlight"><pre>  	<span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>only save attrs that should be persisted:</p>             </td>             <td class="code">               <div class="highlight"><pre>  		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;updated_at&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_theme&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_theme&quot;</span><span class="p">),</span>
			<span class="s2">&quot;current_margin&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;current_margin&quot;</span><span class="p">),</span>
			<span class="s2">&quot;two_up&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;two_up&quot;</span><span class="p">),</span>
			<span class="s2">&quot;font_size&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">),</span>
			<span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span>
			<span class="s2">&quot;epubCFIs&quot;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epubCFIs&quot;</span><span class="p">)</span>
		<span class="p">};</span>
	<span class="p">},</span>

	<span class="nx">toggleFullScreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">fullScreen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;full_screen&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">full_screen</span><span class="o">:</span> <span class="o">!</span><span class="nx">fullScreen</span><span class="p">});</span>
	<span class="p">},</span>

	<span class="nx">increaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">decreaseFont</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;font_size&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">font_size</span><span class="o">:</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
	<span class="p">},</span>

	<span class="nx">toggleToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;toc_visible&quot;</span><span class="p">,</span> <span class="o">!</span><span class="nx">vis</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Description: Obtains the href and hash (if it exists) to set as the current "position"
   of the epub. Any views and models listening to epub attributes are informed through
   the backbone event broadcast.
Arguments (
  href (URL): The url and hash fragment that indicates the position in the epub to set as
  the epub's current position. This argument either has to be the absolute path of the resource in 
  the filesystem, or the path of the resource RELATIVE to the package document.
  When a URI is resolved by the package document model, it assumes that any relative path for a resource is
  relative to the package document.
)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goToHref</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>URL's with hash fragments require special treatment, so
first thing is to split off the hash frag from the rest
of the url:</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">splitUrl</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^#]*)(?:#(.*))?/</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Check if the hash contained a CFI reference</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/epubcfi/</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">this</span><span class="p">.</span><span class="nx">handleCFIReference</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>The href is a standard hash fragment</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: Move this into its own "private" method</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineIndexFromHref</span><span class="p">(</span><span class="nx">splitUrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Rationale: If media overlays are playing, they will cause </p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_overlay_controller&quot;</span><span class="p">).</span><span class="nx">mo</span> <span class="o">&amp;&amp;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;media_overlay_controller&quot;</span><span class="p">).</span><span class="nx">mo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;has_started_playback&quot;</span><span class="p">))</span> <span class="p">{</span>
					
					<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>	
				<span class="p">}</span>	

				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;hash_fragment&quot;</span><span class="p">,</span> <span class="nx">splitUrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">getToc</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getTocItem</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Toc</span><span class="p">.</span><span class="nx">getToc</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">file_path</span><span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)),</span>
				<span class="nx">book</span><span class="o">:</span> <span class="nx">that</span>
			<span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Note: "Section" actually refers to a spine item</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">getCurrentSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">spine_pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getSpineItem</span><span class="p">(</span><span class="nx">spine_pos</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: this should be renamed to indicate it applies to the entire epub.
  This is only passing through this data to avoid breaking code in viewer.js. Eventually
  this should probably be removed. </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">isFixedLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">isFixedLayout</span><span class="p">();</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>------------------------------------------------------------------------------------ //
 "PRIVATE" HELPERS                                                                   //
------------------------------------------------------------------------------------ //</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">handleCFIReference</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">CFI</span><span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">packageDocument</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">hrefOfFirstContentDoc</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">spinePos</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">elementId</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: This is a temporary approach for retrieving a document representation of the 
  package document. Probably best that the package model be able to return this representation of itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>

            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;root_url&quot;</span><span class="p">),</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;xml&quot;</span><span class="p">,</span>
            <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">packageDocument</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>get the href of the first content document</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">hrefOfFirstContentDoc</span> <span class="o">=</span> <span class="nx">EPUBcfi</span><span class="p">.</span><span class="nx">Interpreter</span><span class="p">.</span><span class="nx">getContentDocHref</span><span class="p">(</span><span class="nx">CFI</span><span class="p">,</span> <span class="nx">packageDocument</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>get the spine position of the content document and add the cfi to the current list, set the spine position</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">spinePos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineIndexFromHref</span><span class="p">(</span><span class="nx">hrefOfFirstContentDoc</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Generate an element id from the CFI
REFACTORING CANDIDATE: There is no need for this to be a cryptographic hash function. It was chosen 
  because the Crypto library was already part of Readium. All that is required here is a unique id
  for injected elements. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">elementId</span> <span class="o">=</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">SHA1</span><span class="p">(</span><span class="nx">CFI</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">addCFIwithPayload</span><span class="p">(</span><span class="nx">CFI</span><span class="p">,</span> <span class="nx">spinePos</span><span class="p">,</span> <span class="s2">&quot;&lt;span id=&#39;&quot;</span> <span class="o">+</span> <span class="nx">elementId</span> <span class="o">+</span> <span class="s2">&quot;&#39; class=&#39;cfi_marker&#39; data-cfi=&#39;&quot;</span> <span class="o">+</span> <span class="nx">CFI</span> <span class="o">+</span> <span class="s2">&quot;&#39;&gt;&lt;/span&gt;&quot;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">spinePos</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">elementId</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;hash_fragment&quot;</span><span class="p">,</span> <span class="nx">elementId</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">restorePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">getCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getNextLinearSpinePostition</span><span class="p">();</span>
	<span class="p">},</span>

	<span class="nx">savePosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">Readium</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">epub</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">),</span> <span class="mi">365</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">resolvePath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
	<span class="p">},</span>

	<span class="nx">hasNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getPrevLinearSpinePostition</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">hasPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getNextLinearSpinePostition</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>goes the next linear section in the spine. Non-linear sections should be
skipped as per <a href="http://idpf.org/epub/30/spec/epub30-publications.html#sec-itemref-elem">the spec</a>
REFACTORING CANDIDATE: I think this is a public method and should be moved to the public section</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goToNextSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getNextLinearSpinePostition</span><span class="p">(</span><span class="nx">cp</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>goes the previous linear section in the spine. Non-linear sections should be
skipped as per <a href="http://idpf.org/epub/30/spec/epub30-publications.html#sec-itemref-elem">the spec</a>
REFACTORING CANDIDATE: I think this is a public method and should be moved to the public section</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">goToPrevSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">getPrevLinearSpinePostition</span><span class="p">(</span><span class="nx">cp</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setSpinePos</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Description: Sets the current spine position for the epub, checking if the spine
  item is already rendered. 
Arguments (
 pos (integer): The index of the spine element to set as the current spine position
  goToLastPageOfSection (boolean): Set the viewer to the last page of the spine item (content document/svg)
    that will be loaded.
  reRenderSpinePos (boolean): Force the spine item to be re-rendered, regardless of whether it is the 
    currently set spine item.
  goToHashFragmentId: Set the view position to the element with the specified id. This parameter 
    overrides the behaviour of "goToLastPageOfSection"
)
REFACTORING CANDIDATE: The abstraction here is getting sloppy, as goToHashFragmentId overrides goToLastPageOfSection
  and generally, the behaviour of this method is not entirely clear from its name. Perhaps a simple renaming of the
  method would suffice? Additionally, the internal impementation could be reviewed to tightened up (comments below).</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">setSpinePos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">goToLastPageOfSection</span><span class="p">,</span> <span class="nx">reRenderSpinePos</span><span class="p">,</span> <span class="nx">goToHashFragmentId</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>check for invalid spine position</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">packageDocument</span><span class="p">.</span><span class="nx">spineLength</span><span class="p">())</span> <span class="p">{</span>
			
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">spineItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">spinePosIsRendered</span> <span class="o">=</span> <span class="nx">spineItems</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">renderedItems</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: There is a somewhat hidden dependency here between the paginator
  and the setting of the spine<em>position. The pagination strategy selector re-renders based on the currently
  set spine</em>position on this model. The pagination strategy selector has a reference to this model, which is 
  how it accesses the new spine<em>position, through the "getCurrentSection" method. 
  This would be clearer if the spine</em>position to set were passed explicitly to the paginator. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;spine_position&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: This event should only be triggered for fixed layout sections</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;FXL_goToPage&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Render the new spine position if it is not already rendered. Otherwise, check if a re-render should
be forced (in case a new CFI has to be injected, for example). </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">spinePosIsRendered</span><span class="p">)</span> <span class="p">{</span>

			<span class="nx">renderedItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="nx">goToLastPageOfSection</span><span class="p">,</span> <span class="nx">goToHashFragmentId</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">renderedItems</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="nx">reRenderSpinePos</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">this</span><span class="p">.</span><span class="nx">removeLastPageCFI</span><span class="p">();</span>
				<span class="nx">renderedItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">renderSpineItems</span><span class="p">(</span><span class="nx">goToLastPageOfSection</span><span class="p">,</span> <span class="nx">goToHashFragmentId</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;rendered_spine_items&quot;</span><span class="p">,</span> <span class="nx">renderedItems</span><span class="p">);</span>				
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isFixedLayout</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">goToHashFragmentId</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">paginator</span><span class="p">.</span><span class="nx">v</span><span class="p">.</span><span class="nx">goToHashFragment</span><span class="p">(</span><span class="nx">goToHashFragmentId</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>

	<span class="nx">setMetaSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentSection</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;meta_size&quot;</span><span class="p">,</span> <span class="p">{</span>
				<span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_width&quot;</span><span class="p">),</span>
				<span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;meta_height&quot;</span><span class="p">)</span>
			<span class="p">});</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">meta_section</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:meta_height&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setMetaSize</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>REFACTORING CANDIDATE: The methods related to maintaining a hash of cfi information and payloads
  will likely be refactored into its own backbone object.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">addCFIwithPayload</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">CFI</span><span class="p">,</span> <span class="nx">spinePosition</span><span class="p">,</span> <span class="nx">htmlPayload</span><span class="p">,</span> <span class="nx">bodyType</span><span class="p">)</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">cfiPayload</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">contentDocSpinePos</span> <span class="o">:</span> <span class="nx">spinePosition</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">:</span> <span class="nx">htmlPayload</span><span class="p">,</span> <span class="nx">type</span> <span class="o">:</span> <span class="nx">bodyType</span> <span class="p">};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epubCFIs&quot;</span><span class="p">)[</span><span class="nx">CFI</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cfiPayload</span><span class="p">;</span>
	<span class="p">},</span>

	<span class="nx">addLastPageCFI</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">CFI</span><span class="p">,</span> <span class="nx">spinePosition</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Create last page marker</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">elementId</span> <span class="o">=</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">SHA1</span><span class="p">(</span><span class="nx">CFI</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="s2">&quot;&lt;span id=&#39;&quot;</span> <span class="o">+</span> <span class="nx">elementId</span> <span class="o">+</span> <span class="s2">&quot;&#39; data-last-page-cfi=&#39;&quot;</span> <span class="o">+</span> <span class="nx">CFI</span> <span class="o">+</span> <span class="s2">&quot;&#39; class=&#39;cfi-marker last-page&#39;&gt;&lt;/span&gt;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Create payload</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">cfiPayload</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">contentDocSpinePos</span> <span class="o">:</span> <span class="nx">spinePosition</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">:</span> <span class="nx">marker</span><span class="p">,</span> <span class="nx">type</span> <span class="o">:</span> <span class="s2">&quot;last-page&quot;</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Check if a last page marker already exists</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">CFIPayloads</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epubCFIs&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Check every CFI payload for a "last-page" type, in case more than one exists</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">CFIPayloads</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">currCFI</span><span class="p">,</span> <span class="nx">payloadObject</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;last-page&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">delete</span> <span class="nx">CFIPayloads</span><span class="p">[</span><span class="nx">currCFI</span><span class="p">]</span>
			<span class="p">}</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Add the new last page marker</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epubCFIs&quot;</span><span class="p">)[</span><span class="nx">CFI</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cfiPayload</span><span class="p">;</span>	
	<span class="p">},</span>

	<span class="nx">removeLastPageCFI</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">activeCFIs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;epubCFIs&quot;</span><span class="p">);</span>
		<span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">activeCFIs</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">currCFI</span><span class="p">,</span> <span class="nx">payloadObject</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;last-page&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">delete</span> <span class="nx">activeCFIs</span><span class="p">[</span><span class="nx">currCFI</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 